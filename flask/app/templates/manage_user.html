<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manage_user.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>Admin List</title>
</head>
<body class="">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const mode = localStorage.getItem('darkmode');
          if (mode === 'dark') {
            document.body.classList.add('darkmode');
            document.body.classList.remove('lightmode');
          } else {
            document.body.classList.add('lightmode');
            document.body.classList.remove('darkmode');
          }
        });
        </script>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('homepage') }}" class="back-btn">
                <i class="material-icons">arrow_back_ios</i>
            </a>
        </div>
        <h1 class="page-title" id="title">Admin List</h1>
        <div class="header-right">
            <a href="{{ url_for('pending_user')}}" class="pending-link">
                <i class="material-icons">person_add_alt_1</i>
                {% if pending_count > 0 %}
                <span class="pending-badge">{{ pending_count }}</span>
                {% endif %}
            </a>
        </div>
    </div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="notification is-danger" style="margin: 10px; padding: 10px; background-color: #f44336; color: white; border-radius: 8px;">
            {{ messages[0] }}
        </div>
        {% endif %}
    {% endwith %}
    <div class="main-content">
        <h2 class="section-title" id="subtitle">Main admin management</h2>
        <p class="section-sub" id="desc">Manage admin access and permissions</p>
        
        <div class="search-bar">
            <i class="material-icons" style="color: var(--subtext-color);">search</i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search by name">
        </div>

        <ul class="user-list">
            {% for user in users %}
            <li class="user-item" data-name="{{ user.Fname.lower() }} {{ user.Lname.lower() }}">
                <div class="swipe-wrapper">
                    <div class="user-content" id="content-{{ user.UserID }}">
                        <div class="profile-icon">
                            {% if 'https://' in user.profile_pic %}
                                <img src="{{ user.profile_pic }}" alt="Profile Picture">
                            {% elif user.profile_pic %}
                                <img src="{{ url_for('static', filename='img/' + user.profile_pic) }}" alt="Profile Picture">
                            {% else %}
                                <span>{{ user.Fname[0].upper() }}</span>
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ user.Fname }} {{ user.Lname }}</div>
                            <div class="user-email">{{ user.email }}</div>
                        </div>
                        
                        {% if not user.is_sadmin and current_user.UserID != user.UserID and current_user.is_sadmin %}
                            <form method="post" action="{{ url_for('manage_user') }}" class="toggle-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="user_id" value="{{ user.UserID }}">
                                <label class="switch">
                                    <input type="checkbox" class="admin-toggle"
                                           data-user-name="{{ user.Fname }} {{ user.Lname }}"
                                           {% if user.is_admin %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                                <input type="hidden" class="action-input" name="action" value="">
                            </form>
                        {% endif %}
                    </div>
                    
                    {% if not user.is_sadmin and current_user.UserID != user.UserID and current_user.is_sadmin %}
                        <div class="delete-action">
                            <form method="POST" action="{{ url_for('manage_user') }}">  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="user_id" value="{{ user.UserID }}">
                                <input type="hidden" name="action" value="delete">
                                <button type="submit" class="delete-btn" data-user-name="{{ user.Fname }} {{ user.Lname }}">
                                    <i class="material-icons" style="font-size: 2rem; color:white;">delete</i>
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <p class="modal-message" id="modalMessage"></p>
            <div class="modal-actions">
                <button id="modalConfirm" class="modal-btn confirm">ยืนยัน</button>
                <button id="modalCancel" class="modal-btn cancel">ยกเลิก</button>
            </div>
        </div>
    </div>
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const userItems = document.querySelectorAll('.user-item');
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            userItems.forEach(item => {
                const name = item.dataset.name;
                item.style.display = name.includes(query) ? 'block' : 'none';
            });
        });

        const modal = document.getElementById("confirmModal");
        const modalMessage = document.getElementById("modalMessage");
        const confirmBtn = document.getElementById("modalConfirm");
        const cancelBtn = document.getElementById("modalCancel");

        document.querySelectorAll('.admin-toggle').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();

                const form = this.closest('form');
                const actionInput = form.querySelector('.action-input');
                const userName = this.dataset.userName;
                const isCurrentlyChecked = this.checked;

                if (isCurrentlyChecked) {
                    if (localStorage.getItem('lang') == 'th') {
                        modalMessage.textContent = `คุณแน่ใจแล้วหรือไม่ที่จะให้ ${userName} เป็น admin`;
                    } else {
                        modalMessage.textContent = `Are you sure to promote "${userName}" as an admin?`;
                    }
                    actionInput.value = 'promote';
                } else {
                    if (localStorage.getItem('lang') == 'th') {
                        modalMessage.textContent = `คุณแน่ใจแล้วหรือไม่ที่จะยกเลิกสิทธิ์ admin ของ ${userName}`;
                    } else {
                        modalMessage.textContent = `Are you sure to demote "${userName}" from an admin?`;
                    }
                    actionInput.value = 'demote';
                }
                
                // แสดง pop-up
                modal.classList.add('active');

                //  กำหนดการทำงานของปุ่มใน pop-up
                confirmBtn.onclick = () => {
                    // ถ้ายืนยัน ก็ส่งฟอร์มได้เลย
                    form.submit();
                };

                cancelBtn.onclick = () => {
                    modal.classList.remove('active');
                };
            });
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                const form = this.closest('form');
                const userName = this.dataset.userName;
                if (localStorage.getItem('lang') == 'th') {
                    modalMessage.textContent = `แน่ใจแล้วหรือไม่ที่จะลบ ${userName} ออกจากระบบ`;
                } else {
                    modalMessage.textContent = `Are you sure to remove "${userName}" from the system?`;
                }

                modal.classList.add('active');

                confirmBtn.onclick = () => {
                    form.submit(); 
                };

                cancelBtn.onclick = () => {
                    modal.classList.remove('active'); 
                };
            });
        });

        document.querySelectorAll('.user-content').forEach(content => {
            let startX = 0, dist = 0, isDragging = false;
            const form = content.querySelector('.toggle-form');
            
            if (!form) return; 

            content.addEventListener('touchstart', (e) => {
                isDragging = false;
                startX = e.touches[0].clientX;
                content.style.transition = '';
                form.style.transition = '';
            });

            content.addEventListener('touchmove', (e) => {
                dist = e.touches[0].clientX - startX;
                if (Math.abs(dist) > 10) {
                    isDragging = true;
                }
                if (isDragging && dist < 0 && dist > -100) {
                    e.preventDefault();
                    content.style.transform = `translateX(${dist}px)`;
                    form.style.opacity = 1 - (Math.abs(dist) / 90);
                }
            });

            content.addEventListener('touchend', () => {
                content.style.transition = 'transform 0.3s ease';
                form.style.transition = 'opacity 0.3s ease';
                if (isDragging && dist < -50) {
                    content.style.transform = 'translateX(-90px)';
                    form.style.opacity = 0;
                } else {
                    content.style.transform = 'translateX(0px)';
                    form.style.opacity = 1;
                }
                dist = 0;
                isDragging = false;
            });
        });
    });
    const translations = {
        en: {
            title: "Admin List",
            subtitle: "Main admin management",
            desc: "Manage admin access and permission",
            search: "Search by name",
            cnf: "Confirm",
            cnc: "Cancel"
        },
        th: {
            title: "รายชื่อแอดมิน",
            subtitle: "การจัดการแอดมินหลัก",
            desc: "จัดการสิทธิ์และการเข้าถึงของแอดมิน",
            search: "ค้นหาจากชื่อ",
            cnf: "ยืนยัน",
            cnc: "ยกเลิก"
        }
    };

    function changeLanguage(lang) {
        document.querySelector('#title').textContent = (translations[lang].title);
        document.querySelector('#subtitle').textContent = (translations[lang].subtitle);
        document.querySelector('#desc').textContent = (translations[lang].desc);
        document.querySelector('#searchInput').placeholder = (translations[lang].search);
        document.querySelector('#modalConfirm').textContent = (translations[lang].cnf);
        document.querySelector('#modalCancel').textContent = (translations[lang].cnc);
    }
    
    changeLanguage(localStorage.getItem('lang'));
</script>
</body>
</html>