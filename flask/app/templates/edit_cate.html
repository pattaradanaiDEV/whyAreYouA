<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Edit Categories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pridi:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/category.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=download" />
</head>
<body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const mode = localStorage.getItem('darkmode');
          if (mode === 'dark') {
            document.body.classList.add('darkmode');
            document.body.classList.remove('lightmode');
          } else {
            document.body.classList.add('lightmode');
            document.body.classList.remove('darkmode');
          }
        });
    </script>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('category') }}" class="back-btn">
                <i class="material-icons">arrow_back_ios</i>
            </a>
        </div>
        <h1 class="page-title" id="title">Edit Categories</h1>
    </div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert-box">
            <div class="notification" style="background-color:red;">
                {{ messages[0] }}
            </div>
        </div>
        {% endif %}
    {% endwith %}
    {% for c in cate %}
        <div id="item-list">
            <div class="item-card">
                <div class="swipe-wrapper">
                    {% if c.cateID != 1 %}
                    <div class="delete-action">
                        <form method="POST" id="delete-form-{{c.cateID}}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                            <input type="hidden" name="cate_id" value="{{c.cateID}}">
                            <input type="hidden" name="action" value="delete">
                            <button type="button" class="delete-btn" onclick="showDeleteModal({{c.cateID}})">
                                <i class="material-icons" style="font-size: 2rem; color:white;">delete</i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    <div class="item-content" id="content-{{c.cateID}}"
                        {% if c.cateID != 1 %}
                        ontouchstart="startSwipe(event, {{c.cateID}})"
                        ontouchmove="moveSwipe(event, {{c.cateID}})"
                        ontouchend="endSwipe(event, {{c.cateID}})"
                        {% endif %}
                        >
                        <div class="item-info">
                            <div class="item-name">
                                {{c.cateName}}
                            </div>
                        </div>
                    </div>
                </div>
                {% set details = namespace(b=false) %}
                {% for i in items %}
                    {% if(( i.category.cateName == c.cateName) or (c.cateName == 'Free cate')) %}
                        {% set details.b = true %}
                    {% endif %}
                {% endfor %}
                {% if details.b %}
                <div class="item-content">
                    <details class="detail">
                        <summary class="items">Items</summary>
                        {% for i in items %}
                            {% if (i.category.cateName == c.cateName) %}
                            <div class="item-category">{{ i.itemName }}</div>
                            {% endif %}
                        {% endfor %}
                    </details>
                </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
    <div class="modal-overlay" id="delete-modal">
        <div class="modal-content">
            <p class="modal-message" id="delete-modal-message"></p>
            <div class="modal-actions">
                <button class="modal-btn confirm" id="confirm-delete-btn">Confirm</button>
                <button class="modal-btn cancel" id="cancel-delete-btn">Cancel</button>
            </div>
        </div>
    </div>

<script>
    function gobackto(){ window.location.href ='/category' }
    
    const translations = {
      en: {
        title: "Category Edit",
        items: 'Items',
        delBtn: 'Delete',
      },
      th: {
        title: "แก้ไขประเภทของ",
        items: 'รายการของ',
        delBtn: 'ลบ',
      }
    };

    function changeLanguage(lang) {
        document.querySelector('#title').textContent = (translations[lang].title);
        document.querySelectorAll('.items').forEach(e => {
            e.textContent = (translations[lang].items);
        });
        document.querySelectorAll('.delBtn').forEach(e => {
            e.textContent = (translations[lang].delBtn);
        });
    }
      
    changeLanguage(localStorage.getItem('lang'));
    const categories = [
        {% for c in cate %}
            { "cateID": {{ c.cateID }}, "cateName": "{{ c.cateName | e }}" }
            {% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    let cateToDeleteId = null;

    function showDeleteModal(cateID) {
        cateToDeleteId = cateID;
        const cate = categories.find(c => c.cateID === cateID); 
        const modalMessage = document.getElementById('delete-modal-message');

        if (cate) {
            modalMessage.innerHTML = `Are you sure? ,if you delete <strong>${cate.cateName}</strong> ,it will move item in <strong>${cate.cateName}</strong>
            to Free Cate?`;
        } else {
            modalMessage.textContent = 'Are you sure you want to delete this item?';
        }

        deleteModal.classList.add('active');
    }

    function hideDeleteModal() {
        cateToDeleteId = null;
        deleteModal.classList.remove('active');
    }
    
    confirmDeleteBtn.addEventListener('click', () => {
        if (cateToDeleteId) {
            const form = document.getElementById(`delete-form-${cateToDeleteId}`);
            if (form) {
                form.submit();
            }
        }
        hideDeleteModal();
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteModal);

    deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
            hideDeleteModal();
        }
    });

    let startX = 0;
    let currentX = 0;
    let isDragging = false; 

    function startSwipe(e, id) {
        if (!{{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }}) { return; }
        
        isDragging = false; 

        const allDetails = document.querySelectorAll('#item-list .detail[open]');
        allDetails.forEach(detail => { detail.open = false; });

        const content = document.getElementById(`content-${id}`);
        startX = e.touches[0].clientX;
        content.style.transition = ''; 
    }

    function moveSwipe(e, id) {
        if (!{{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }}) { return; }
        
        const content = document.getElementById(`content-${id}`);
        currentX = e.touches[0].clientX;
        let diff = currentX - startX;

        if (Math.abs(diff) > 10) { // Threshold of 10 pixels
            isDragging = true;
        }
        
        if (isDragging && diff < 0 && diff > -100) {
            content.style.transform = `translateX(${diff}px)`;
        }
    }

    function endSwipe(e, id) {
        if (!{{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }}) { return; }
        
        const content = document.getElementById(`content-${id}`);
        content.style.transition = 'transform 0.3s ease'; 
        
        if (!isDragging) {
            content.style.transform = 'translateX(0px)'; // Ensure it snaps back on a simple tap
            return; // Exit function if it was just a tap
        }

        let diff = currentX - startX;
        if (diff < -60) {
            content.style.transform = `translateX(-90px)`; 
        } else {
            content.style.transform = 'translateX(0px)';
        }
        
        startX = 0;
        currentX = 0;
        isDragging = false;
    }
</script>
</body>
</html>
