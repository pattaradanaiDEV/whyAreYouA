<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pridi:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/cart.css">
    <link rel="stylesheet" href="../static/css/category.css">
</head>
<body>
    <div class="container mt-4">
        <div class="top-bar">
            <div class="back">
                <a href="{{ url_for('category') }}">
                    <span class="material-icons">arrow_back_ios_new</span> 
                </a>
            </div>
            <h4 class="text-center mb-4">My Cart</h4>
        </div>
        {% for c in cart_items %}
        <div class="cart-item" id="cart-{{ c.CartID }}"
            ontouchstart="startSwipe(event, {{ c.CartID }})"
            ontouchmove="moveSwipe(event, {{ c.CartID }})"
            ontouchend="endSwipe(event, {{ c.CartID }})">

            <div class="delete-bg">
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                <input type="hidden" name="action" value="delete">
                <button type="submit" class="btn btn-danger btn-sm">‡∏•‡∏ö</button>
            </form>
            </div>

            <div class="cart-content" id="content-{{ c.CartID }}">
            <img src="{{ url_for('static', filename='uploads/' ~ c.item.itemPicture) }}"
                width="70" height="70" class="rounded">
            <div class="cart-info">
                <b>{{ c.item.itemName }}</b><br>
                {% if c.Status == 'w' %}
                <span class="status-w">Withdraw</span>
                {% else %}
                <span class="status-e">Edit</span>
                {% endif %}
            </div>

            <div class="quantity-control">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                    <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                    <input type="hidden" name="action" value="decrease">
                    <button class="btn btn-outline-dark btn-sm">-</button>
                </form>

                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                    <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                    <input type="hidden" name="action" value="update_input">
                    <input type="number" name="quantity" min="1" value="{{ c.Quantity }}" onchange="this.form.submit()">
                </form>

                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                    <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                    <input type="hidden" name="action" value="increase">
                    <button class="btn btn-outline-dark btn-sm">+</button>
                </form>
            </div>
            </div>
        </div>
        {% endfor %}

        {% if not cart_items %}
            <p class="text-center text-muted mt-5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ üõçÔ∏è</p>
        {% else %}
            <form method="POST" class="text-center">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                <input type="hidden" name="action" value="confirm_cart">
                <button class="confirm-btn">Confirm Cart</button>
            </form>
        {% endif %}
        </div>

        <div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="toast align-items-center text-bg-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'info' }} border-0 show mb-2">
                <div class="d-flex">
                <div class="toast-body">{{ message }}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
<script>
    let startX = 0;
    let currentX = 0;
    let swiping = false;
    let moved = false;

    function startSwipe(e, id) {
    startX = e.touches[0].clientX;
    swiping = true;
    moved = false;
    }

    function moveSwipe(e, id) {
    if (!swiping) return;
    currentX = e.touches[0].clientX;
    let diff = currentX - startX;

    if (Math.abs(diff) > 10) moved = true;

    if (diff < 0 && Math.abs(diff) < 100) {
        document.getElementById(`content-${id}`).style.transform = `translateX(${diff}px)`;
    }
    }

    function endSwipe(e, id) {
    const item = document.getElementById(`cart-${id}`);
    const content = document.getElementById(`content-${id}`);
    let diff = currentX - startX;
    swiping = false;

    if (!moved || Math.abs(diff) < 30) {
        item.classList.remove("swiped");
        content.style.transform = "translateX(0)";
        return;
    }

    if (diff < -60) {
        item.classList.add("swiped");
        content.style.transform = "translateX(-80px)";
    } else {
        item.classList.remove("swiped");
        content.style.transform = "translateX(0)";
    }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
