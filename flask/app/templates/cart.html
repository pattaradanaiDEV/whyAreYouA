<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
</head>
<body>
    <script>
        const darkmode = localStorage.getItem('darkmode');
        if(darkmode === 'active') {
          document.body.classList.add('darkmode');
        } else {
          document.body.classList.remove('darkmode');
        }
    </script>

    <div class="top-bar">
        <a href="{{ url_for('category') }}">
            <span class="material-icons">arrow_back_ios</span>
        </a>
        <span class="title">Cart</span>
    </div>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-box">
            {% for category, message in messages %}
                <div class="notification {{ category }}">
                {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}
        {% for c in cart_items %}
        <div class="cart-item-wrapper" id="wrapper-{{ c.CartID }}"
             ontouchstart="startSwipe(event, {{ c.CartID }})"
             ontouchmove="moveSwipe(event, {{ c.CartID }})"
             ontouchend="endSwipe(event, {{ c.CartID }})">

            <div class="delete-action">
                <form method="POST" id="delete-form-{{ c.CartID }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                    <input type="hidden" name="action" value="delete">
                    <button type="button" class="delete-btn" onclick='showDeleteModal({{ c.CartID }}, {{ c.item.itemName|tojson }})'>
                        <span class="material-icons" style="font-size: 2rem; color:white;">delete</span>
                    </button>
                </form>
            </div>

            <div class="cart-item-content" id="content-{{ c.CartID }}">
                <div class="item-image">
                    {% if c.item.itemPicture %}
                    <img src="{{ url_for('static', filename='img/' ~ c.item.itemPicture) }}" alt="{{ c.item.itemName }}">
                    {% else %}
                    <div class="placeholder">{{ c.item.itemName[0] }}</div>
                    {% endif %}
                </div>

                <div class="item-info">
                    <div class="item-name">{{ c.item.itemName }}</div>
                    <div class="item-stock">In stock : {{ c.item.itemAmount }}</div>
                    {% if c.Status == 'w' %}
                    <div class="status withdraw">Withdraw</div>
                    {% else %}
                    <div class="status edit">Edit</div>
                    {% endif %}
                </div>

                <div class="quantity-control">
                    <form method="POST" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                        <input type="hidden" name="action" value="decrease">
                        <button type="submit" class="qty-btn">-</button>
                    </form>
                    
                    <form method="POST" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                        <input type="hidden" name="action" value="update_input">
                        <input type="number" name="quantity" min="1" value="{{ c.Quantity }}" onchange="this.form.submit()">
                    </form>

                    <form method="POST" style="display: contents;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="cart_id" value="{{ c.CartID }}">
                        <input type="hidden" name="action" value="increase">
                        <button type="submit" class="qty-btn">+</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if not cart_items %}
        <p class="text-center mt-5">No items in cart</p>
        {% else %}
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="confirm_cart">
            <button class="confirm-btn">Confirm Cart</button>
        </form>
        {% endif %}
    </div>

    <div class="modal-overlay" id="delete-modal">
        <div class="modal-content">
            <p class="modal-message" id="delete-modal-message">Are you sure?</p>
            <div class="modal-actions">
                <button class="modal-btn confirm" id="confirm-delete-btn">Delete</button>
                <button class="modal-btn cancel" id="cancel-delete-btn">Cancel</button>
                
            </div>
        </div>
    </div>

<script>
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;      
    let hasMovedEnough = false; 

    const MOVE_THRESHOLD = 10;    
    const SWIPE_THRESHOLD = -60;  
    const DELETE_BUTTON_WIDTH = 90; 

    function startSwipe(e, id) {
        document.querySelectorAll('.cart-item-content').forEach(content => {
            if (content.id !== `content-${id}`) {
                content.style.transition = 'transform 0.3s ease-out';
                content.style.transform = 'translateX(0px)';
            }
        });

        isSwiping = true;
        hasMovedEnough = false; 
        startX = e.touches[0].clientX;
        
        const content = document.getElementById(`content-${id}`);
        content.style.transition = 'none'; 
    }

    function moveSwipe(e, id) {
        if (!isSwiping) return;

        currentX = e.touches[0].clientX;
        let diff = currentX - startX;

        if (!hasMovedEnough && Math.abs(diff) > MOVE_THRESHOLD) {
            hasMovedEnough = true;
        }

        if (hasMovedEnough) {
            if (diff < 0 && diff > -DELETE_BUTTON_WIDTH - 20) {
                const content = document.getElementById(`content-${id}`);
                content.style.transform = `translateX(${diff}px)`;
            }
        }
    }

    function endSwipe(e, id) {
        if (!isSwiping) return;
        isSwiping = false;

        const content = document.getElementById(`content-${id}`);
        content.style.transition = 'transform 0.3s ease-out';

        if (!hasMovedEnough) {
            content.style.transform = 'translateX(0px)';
            return;
        }
        
        let diff = currentX - startX;
        
        if (diff < SWIPE_THRESHOLD) {
            content.style.transform = `translateX(-${DELETE_BUTTON_WIDTH}px)`;
        } else {
            content.style.transform = 'translateX(0px)';
        }
        
        startX = 0;
        currentX = 0;
    }

    // --- Modal Logic ---
    const deleteModal = document.getElementById('delete-modal');
    const modalMessage = document.getElementById('delete-modal-message');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    let cartIdToDelete = null;

    function showDeleteModal(cartID, itemName) {
        cartIdToDelete = cartID;
        modalMessage.innerHTML = `Are you sure you want to delete <strong>${itemName}</strong>?`;
        deleteModal.classList.add('active');
    }

    function hideDeleteModal() {
        cartIdToDelete = null;
        deleteModal.classList.remove('active');
    }

    confirmDeleteBtn.addEventListener('click', () => {
        if (cartIdToDelete) {
            const form = document.getElementById(`delete-form-${cartIdToDelete}`);
            if (form) {
                form.submit();
            }
        }
        hideDeleteModal();
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteModal);
    deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
            hideDeleteModal();
        }
    });
</script>
</body>
</html>