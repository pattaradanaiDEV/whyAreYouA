<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/category.css">
</head>

<body>
	<div class="top-bar">
    	<div class="back">
        	<a href="{{ url_for('stockmenu') }}">
                <span class="material-icons" color="#FFFFFF">arrow_back_ios_new</span> 
            </a>
    	</div>
    	<div class="category">
        	<span class="material-icons">list_alt</span>
        	<span>Category</span>
    	</div>
        <div class="cart">
            <a href="{{ url_for('cart') }}">
                <span class="material-icons">shopping_cart</span>
            </a>
    	</div>
	</div>

	<div class="search-bar">
    	<span class="material-icons">search</span>
    	<input type="text" class="search-input" placeholder="Search...">
	</div>

	<div class="show_category">
        <button class="category-item" onclick="filterCategory('all')">All Items</button>    
        {% for cate in categories %}
            {% if cate['cateName'] != 'Free cate'%}
            <button class="category-item" onclick="filterCategory('{{ cate['cateName'] }}')">
                {{ cate['cateName'] }}
            </button> 
            {% endif %}  
        {% endfor %}
	</div>

    <div id="item-list"></div>
    <input type="hidden" id="is_admin" value="{{ 1 if is_admin else 0 }}">
</body>
</html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    const items = {{ items|tojson }};
    const is_admin = document.getElementById("is_admin").value === "1";

    function renderItems(data) {
        $("#item-list").empty();
        data.forEach(it => {
            let html = `
            <div class="item-card">
                <div class="item-left">
                    <div class="item-icon">
                        ${it.itemName.substring(0,1)}
                    </div>
                </div>
                <div class="item-info">
                    <div class="item-name">${it.itemName}</div>
                    <div class="item-category">${it.category.cateName}</div>
                    <div class="item-stock">Stock: ${it.itemAmount}</div>
                </div>
                <div class="item-actions">
                    ${is_admin 
                        ? `<button class="btn edit" onclick="edit_item(${it.itemID}, 1)">Edit</button>` 
                        : ""
                    }
                    <button class="btn withdraw" onclick="withdraw(${it.itemID}, 1)">Withdraw</button>
                </div>
            </div>`;
            $("#item-list").append(html);
        });
    }
    function edit_item(itemID, userID) {
        window.location.href = `/edit?itemID=${itemID}&userID=${userID}`;
    }
    function withdraw(itemID, userID) {
        window.location.href = `/withdraw?itemID=${itemID}&userID=${userID}`;
    }
    function filterCategory(cateName) {
        if (cateName === "all") {
            renderItems(items);
        } else {
            renderItems(items.filter(it => it.category.cateName === cateName));
        }
    }
    function searchCategory(query) {
        if (query === "") {
            renderItems(items);
            return;
        }

        const filteredData = items.filter(item =>
            item.itemName.toLowerCase().includes(query.toLowerCase()) || item.category.cateName.toLowerCase().includes(query.toLowerCase())
        );

        renderItems(filteredData);
    }
    document.querySelector('.search-bar input').addEventListener('input', function(event) {
        searchCategory(event.target.value.trim());
    });

    window.onload = function() {
        filterCategory("all");
    };
</script>