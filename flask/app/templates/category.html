<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pridi:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/category.css') }}">
    <title>Category Page</title>
</head>
<body>
    <script>
        const darkmode = localStorage.getItem('darkmode');
        if(darkmode === 'active') {
          document.body.classList.add('darkmode');
        } else {
          document.body.classList.remove('darkmode');
        }
    </script>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('homepage') }}" class="back-btn">
                <i class="material-icons">arrow_back_ios</i>
            </a>
        </div>
        <h1 class="page-title">Category</h1>
        <div class="cart">
            <a href="{{ url_for('cart')}}" class="cart-link">
                <i class="material-icons" style="color:black;">shopping_cart</i>
                {% if cart_count > 0 %}
                <span class="cart-badge">{{ cart_count }}</span>
                {% endif %}
            </a>
        </div>
    </div>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert-box">
        <div class="notification">
            {{ messages[0] }}
        </div>
    </div>
    {% endif %}
    {% endwith %}
    <div class="search-bar">
        <span class="material-icons">search</span>
        <input type="text" class="search-input" placeholder="Search">
    </div>

    <div class="show_category">
        <button class="category-item" onclick="filterCategory('all')">All Items</button>     
        {% for cate in categories %}
            {% if cate['cateName'] != 'Free cate'%}
            <button class="category-item" onclick="filterCategory('{{ cate['cateName'] }}')">
                {{ cate['cateName'] }}
            </button>
            {% endif %}    
        {% endfor %}
    </div>

    <div id="item-list"></div>
     <div class="modal-overlay" id="delete-modal">
        <div class="modal-content">
            <p class="modal-message" id="delete-modal-message"></p>
            <div class="modal-actions">
                <button class="modal-btn confirm" id="confirm-delete-btn">Confirm</button>
                <button class="modal-btn cancel" id="cancel-delete-btn">Cancel</button>
            </div>
        </div>
    </div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const items = {{ items|tojson }}; 

    function getDisplayHTML(it) {
        let pictureHtml = '';
        if (it.itemPicture) {
            pictureHtml = `<img src="/static/img/${it.itemPicture}" alt="${it.itemName}">`;
        } else {
            let ch = it.itemName ? it.itemName.substring(0,1) : '?';
            pictureHtml = `<div class="item-icon">${ch}</div>`;
        }
        
        return `
            <div class="item-card" data-id="${it.itemID}" id="item-${it.itemID}">
                <div class="swipe-wrapper">
                    <div class="delete-action">
                        <form method="POST" id="delete-form-${it.itemID}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                            <input type="hidden" name="item_id" value="${it.itemID}">
                            <input type="hidden" name="action" value="delete">
                            <button type="button" class="delete-btn" onclick="showDeleteModal(${it.itemID})">
                                <i class="material-icons">delete</i>
                            </button>
                        </form>
                    </div>

                    <div class="item-content" id="content-${it.itemID}"
                        ontouchstart="startSwipe(event, ${it.itemID})"
                        ontouchmove="moveSwipe(event, ${it.itemID})"
                        ontouchend="endSwipe(event, ${it.itemID})">
                        
                        <div class="item-left">${pictureHtml}</div>
                        <div class="item-info">
                            <div class="item-name">${it.itemName}</div>
                            <div class="item-category">${it.category.cateName}</div>
                            <div class="item-stock">Stock: ${it.itemAmount}</div>
                        </div>
                        <div class="item-actions">
                            ${it.is_admin ? `<button class="btn edit" onclick="gotoEdit(${it.itemID})">Edit</button>` : ""}
                            <button class="btn withdraw" onclick="withdraw(${it.itemID})">Withdraw</button>
                        </div>
                    </div>
                </div>
                <details class="detail">
                    <summary onclick="loadQrCode(${it.itemID}, this)">Detail</summary>
                    <div class="description-content">
                        ${it.itemDesc || 'No description available.'}
                        <div id="qr-placeholder-${it.itemID}"></div>
                    </div>
                </details>
            </div>`;
    }

    let startX = 0;
    let currentX = 0;
    let isDragging = false; 

    function startSwipe(e, id) {
        if (!{{ 1 if current_user.IsM_admin else 0 }}) { return; }
        
        isDragging = false; 

        const allDetails = document.querySelectorAll('#item-list .detail[open]');
        allDetails.forEach(detail => { detail.open = false; });

        const content = document.getElementById(`content-${id}`);
        startX = e.touches[0].clientX;
        content.style.transition = ''; 
    }

    function moveSwipe(e, id) {
        if (!{{ 1 if current_user.IsM_admin else 0 }}) { return; }
        
        const content = document.getElementById(`content-${id}`);
        currentX = e.touches[0].clientX;
        let diff = currentX - startX;

        if (Math.abs(diff) > 10) { // Threshold of 10 pixels
            isDragging = true;
        }
        
        if (isDragging && diff < 0 && diff > -100) {
            content.style.transform = `translateX(${diff}px)`;
        }
    }

    function endSwipe(e, id) {
        if (!{{ 1 if current_user.IsM_admin else 0 }}) { return; }
        
        const content = document.getElementById(`content-${id}`);
        content.style.transition = 'transform 0.3s ease'; 
        
        if (!isDragging) {
            content.style.transform = 'translateX(0px)'; // Ensure it snaps back on a simple tap
            return; // Exit function if it was just a tap
        }

        let diff = currentX - startX;
        if (diff < -60) {
            content.style.transform = `translateX(-90px)`; 
        } else {
            content.style.transform = 'translateX(0px)';
        }
        
        startX = 0;
        currentX = 0;
        isDragging = false;
    }

    
    
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    let itemToDeleteId = null;

    function showDeleteModal(itemID) {
    itemToDeleteId = itemID;
    const item = items.find(it => it.itemID === itemID); // ค้นหา item จาก ID
    const modalMessage = document.getElementById('delete-modal-message');

    if (item) {
        modalMessage.innerHTML = `Are you sure you want to delete <strong>${item.itemName}</strong>?`;
    } else {
        modalMessage.textContent = 'Are you sure you want to delete this item?';
    }

    deleteModal.classList.add('active');
}

    function hideDeleteModal() {
        itemToDeleteId = null;
        deleteModal.classList.remove('active');
    }
    
    confirmDeleteBtn.addEventListener('click', () => {
        if (itemToDeleteId) {
            const form = document.getElementById(`delete-form-${itemToDeleteId}`);
            if (form) {
                form.submit();
            }
        }
        hideDeleteModal();
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteModal);

    deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
            hideDeleteModal();
        }
    });
    async function loadQrCode(itemID, summaryElement) {
        const detailsElement = summaryElement.parentElement;
        if (!detailsElement.open) {
            if (summaryElement.dataset.loaded === 'true') { return; }
            summaryElement.dataset.loaded = 'true';
            const placeholder = document.getElementById(`qr-placeholder-${itemID}`);
            placeholder.innerHTML = '<p>Loading QR Code...</p>';
            try {
                const response = await fetch(`/get_qr/${itemID}`);
                if (!response.ok) throw new Error('Failed to fetch QR code.');
                const data = await response.json();
                if (data.success) {
                    const qrImageSrc = `data:image/png;base64,${data.qr_code_base64}`;
                    placeholder.innerHTML = `
                        <div class="qr-container-description">
                            <h4>QR Code</h4>
                            <img src="${qrImageSrc}" alt="QR Code for ${data.item_name}">
                            <button type="button" onclick="printQrForCard('${qrImageSrc}', '${data.item_name}')">Print QR</button>
                        </div>
                    `;
                } else { throw new Error(data.error || 'Unknown error occurred.'); }
            } catch (error) {
                placeholder.innerHTML = `<p style="color: red;">${error.message}</p>`;
                delete summaryElement.dataset.loaded;
            }
        }
    }
    function printQrForCard(qrImageSrc, itemName) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html>...</html>`); 
        printWindow.document.close();
        printWindow.onafterprint = () => printWindow.close();
    }
    function renderItems(data) {
        $("#item-list").empty();
        data.forEach(it => {
            it.is_admin = {{ 1 if current_user.IsM_admin else 0 }};
            $("#item-list").append(getDisplayHTML(it));
        });
    }
    function gotoEdit(id){ window.location.href = `/edit?itemID=${id}`; }
    function withdraw(itemID) { window.location.href = `/withdraw?itemID=${itemID}`; }
    function filterCategory(cateName) {
        if (cateName === "all") { renderItems(items); } 
        else { renderItems(items.filter(it => it.category.cateName === cateName)); }
    }
    function searchCategory(query) {
        if (query === "") { renderItems(items); return; }
        const filteredData = items.filter(item =>
            item.itemName.toLowerCase().includes(query.toLowerCase()) || item.category.cateName.toLowerCase().includes(query.toLowerCase())
        );
        renderItems(filteredData);
    }
    document.querySelector('.search-bar input').addEventListener('input', (event) => searchCategory(event.target.value.trim()));
    window.onload = () => filterCategory("all");
</script>
</body>
</html>