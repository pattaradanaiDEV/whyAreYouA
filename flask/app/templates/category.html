<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pridi:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/category.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=download" />
    <title>Category Page</title>
</head>
<body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const mode = localStorage.getItem('darkmode');
          if (mode === 'dark') {
            document.body.classList.add('darkmode');
            document.body.classList.remove('lightmode');
          } else {
            document.body.classList.add('lightmode');
            document.body.classList.remove('darkmode');
          }
        });
        </script>
    <div class="header">
        <div class="header-left">
            <a href="{{ url_for('homepage') }}" class="back-btn">
                <i class="material-icons">arrow_back_ios</i>
            </a>
        </div>
        <h1 class="page-title" id="title">Category</h1>
        <div class="cart">
            <a href="{{ url_for('exportStock') }}" class="back-btn export-btn" id="export-btn">
                <span class="material-symbols-outlined">download</span>
            </a>
            <a href="{{ url_for('cart')}}" class="back-btn">
                <i class="material-icons">shopping_cart</i>
                {% if cart_count > 0 %}
                <span class="cart-badge">{{ cart_count }}</span>
                {% endif %}
            </a>
        </div>
    </div>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert-box">
        <div class="notification">
            {{ messages[0] }}
        </div>
    </div>
    {% endif %}
    {% endwith %}
    <div class="sub-top-bar">
        {% if (current_user.is_admin or current_user.is_sadmin) %}
            <div class="search-bar">
                <span class="material-icons">search</span>
                <input type="text" class="search-input" placeholder="Search" id="search">
            </div>
            <div class="edit-cate">  
                <a href="{{ url_for('cate_edit') }}" class="back-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                        <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/>
                    </svg>
                </a>
            </div>
        {% else %}
            <div class="search-bar search-bar-full">
                <span class="material-icons">search</span>
                <input type="text" class="search-input" placeholder="Search" id="search">
            </div>
        {% endif %}
    </div>

    <div class="show_category">
        <button class="category-item" onclick="filterCategory('all')">All Items</button>     
        {% for cate in categories %}
            {% if cate['cateName'] != 'Free cate'%}
            <button class="category-item" onclick="filterCategory('{{ cate['cateName'] }}')">
                {{ cate['cateName'] }}
            </button>
            {% endif %}    
        {% endfor %}
    </div>

    <div id="item-list"></div>
    <div class="modal-overlay" id="delete-modal">
        <div class="modal-content">
            <p class="modal-message" id="delete-modal-message"></p>
            <div class="modal-actions">
                <button class="modal-btn confirm" id="confirm-delete-btn">Confirm</button>
                <button class="modal-btn cancel" id="cancel-delete-btn">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="qr-print-modal">
        <div class="modal-content">
            <h3 id="qr-modal-title">Print Options</h3>
            <div class="form-group">
                <label for="qr-size" id="qr-label-size">Size:</label>
                <select id="qr-size" class="modal-select">
                    <option value="L">L (10cm x 10cm)</option>
                    <option value="M" selected>M (8cm x 8cm)</option>
                    <option value="S">S (5cm x 5cm)</option>
                    <option value="XS">XS (3cm x 3cm)</option>
                    <option value="XXS">XXS (2cm x 2cm)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="qr-quantity" id="qr-label-quantity">Quantity:</label>
                <input type="number" id="qr-quantity" value="1" min="1" class="modal-input">
            </div>
            <div class="modal-actions">
                <button class="modal-btn confirm" id="confirm-print-btn">Confirm</button>
                <button class="modal-btn cancel" id="cancel-print-btn">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="success-modal">
        <div class="modal-content success-modal-content">
            <div class="success-icon">
                <span class="material-icons">check</span>
            </div>
            <h3 class="success-title" id="success-title-text">Success!</h3>
            <p class="modal-message" id="success-message-text">Your PDF has been downloaded.</p>
            <div class="modal-actions">
                <button class="modal-btn success" id="success-continue-btn">Continue</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="loading-modal">
        <div class="modal-content success-modal-content">
            <div class="spinner"></div>
            
            <h3 class="success-title" id="loading-title-text">Generating...</h3>
            <p class="modal-message" id="loading-message-text">Your Excel file is being prepared.</p>
        </div>
    </div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const CSRF_TOKEN = "{{ csrf_token() }}";
</script>
<script>
    const items = {{ items|tojson }}; 

    const translations = {
        en: {
            title: "Stock",
            search: "Search",
            stock: "Stock",
            description: "Description",
            edit: 'Edit',
            withdrw: 'Withdraw',
            cnf: 'Confirm',
            cnc: 'Cancel',
            printOptions: "Print Options",
            size: "Size",
            quantity: "Quantity"
        },
        th: {
            title: "คลัง",
            search: "ค้นหา",
            stock: "ของคงเหลือ",
            description: "คำอธิบายรายละเอียด",
            edit: 'แก้ไข',
            withdrw: 'เบิก',
            cnf: 'ยืนยัน',
            cnc: 'ยกเลิก',
            printOptions: "ตัวเลือกการพิมพ์",
            size: "ขนาด",
            quantity: "จำนวน"
        }
    };

    function getDisplayHTML(it) {
        let pictureHtml = '';
        if (it.itemPicture) {
            pictureHtml = `<img src="/static/img/${it.itemPicture}" alt="${it.itemName}">`;
        } else {
            let ch = it.itemName ? it.itemName.substring(0,1) : '?';
            pictureHtml = `<div class="item-icon">${ch}</div>`;
        }
        desc = ""
        if (it.itemDesc) {
            desc = it.itemDesc
        } else {
            if (localStorage.getItem('lang') == 'en') {
                desc = 'No description available.'
            } else {
                desc = 'ยังไม่มีรายละเอียดคำอธิบาย'
            }
        }
        stock_text = translations[localStorage.getItem('lang')].stock || 'Stock'
        description = translations[localStorage.getItem('lang')].description
        edit = translations[localStorage.getItem('lang')].edit
        withdrw = translations[localStorage.getItem('lang')].withdrw

        return `<div class="item-card" data-id="${it.itemID}" id="item-${it.itemID}">
            <div class="swipe-wrapper">
                <div class="delete-action">
                    <form method="POST" id="delete-form-${it.itemID}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                        <input type="hidden" name="item_id" value="${it.itemID}">
                        <input type="hidden" name="action" value="delete">
                        <button type="button" class="delete-btn" onclick="showDeleteModal(${it.itemID})">
                            <i class="material-icons" style="font-size: 2rem; color:white;">delete</i>
                        </button>
                    </form>
                </div>

                <div class="item-content" id="content-${it.itemID}"
                    ontouchstart="startSwipe(event, ${it.itemID})"
                    ontouchmove="moveSwipe(event, ${it.itemID})"
                    ontouchend="endSwipe(event, ${it.itemID})">
                    
                    <div class="item-left">${pictureHtml}</div>
                    <div class="item-info">
                        <div class="item-name">${it.itemName}</div>
                        <div class="item-category">${it.category.cateName}</div>
                        <div class="item-stock">${stock_text}: ${it.itemAmount}</div>
                    </div>
                    <div class="item-actions">
                        ${it.is_admin ? `<button class="btn edit" onclick="gotoEdit(${it.itemID})">${edit}</button>` : ""}
                        <button class="btn withdraw" onclick="withdraw(${it.itemID})">${withdrw}</button>
                    </div>
                </div>
            </div>
            <details class="detail">
                <summary onclick="loadQrCode(${it.itemID}, this)">${description}</summary>
                <div class="description-content">
                    ${desc}
                    <div id="qr-placeholder-${it.itemID}"></div>
                </div>
            </details>
        </div>`;
    }

    let startX = 0;
    let currentX = 0;
    let isDragging = false; 

    function startSwipe(e, id) {
        if (!{{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }}) { return; }
        
        isDragging = false; 

        const allDetails = document.querySelectorAll('#item-list .detail[open]');
        allDetails.forEach(detail => { detail.open = false; });

        const content = document.getElementById(`content-${id}`);
        startX = e.touches[0].clientX;
        content.style.transition = ''; 
    }

    function moveSwipe(e, id) {
        if (!{{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }}) { return; }
        
        const content = document.getElementById(`content-${id}`);
        currentX = e.touches[0].clientX;
        let diff = currentX - startX;

        if (Math.abs(diff) > 10) { 
            isDragging = true;
        }
        
        if (isDragging && diff < 0 && diff > -100) {
            content.style.transform = `translateX(${diff}px)`;
        }
    }

    function endSwipe(e, id) {
        if (!{{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }}) { return; }
        
        const content = document.getElementById(`content-${id}`);
        content.style.transition = 'transform 0.3s ease'; 
        
        if (!isDragging) {
            content.style.transform = 'translateX(0px)'; 
            return; 
        }

        let diff = currentX - startX;
        if (diff < -60) {
            content.style.transform = `translateX(-90px)`; 
        } else {
            content.style.transform = 'translateX(0px)';
        }
        
        startX = 0;
        currentX = 0;
        isDragging = false;
    }


    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    let itemToDeleteId = null;

    function showDeleteModal(itemID) {
        itemToDeleteId = itemID;
        const item = items.find(it => it.itemID === itemID); // ค้นหา item จาก ID
        const modalMessage = document.getElementById('delete-modal-message');

    if (item) {
        if (localStorage.getItem('lang') == 'en') {
            modalMessage.innerHTML = `Are you sure you want to delete <strong>${item.itemName}</strong>?`;
        } else {
            modalMessage.innerHTML = `คุณแน่ใจหรือไม่ที่จะลบ <strong>${item.itemName}</strong>?`;
        }
    } else {
        if (localStorage.getItem('lang') == 'en') {
            modalMessage.textContent = 'Are you sure you want to delete this item?';
        } else {
            modalMessage.textContent = 'คุณแน่ใจหรือไม่ที่จะทำการลบของชิ้นนี้?';
        }
    }

        deleteModal.classList.add('active');
    }

    function hideDeleteModal() {
        itemToDeleteId = null;
        deleteModal.classList.remove('active');
    }
    
    confirmDeleteBtn.addEventListener('click', () => {
        if (itemToDeleteId) {
            const form = document.getElementById(`delete-form-${itemToDeleteId}`);
            if (form) {
                form.submit();
            }
        }
        hideDeleteModal();
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteModal);

    deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
            hideDeleteModal();
        }
    });


    const qrPrintModal = document.getElementById('qr-print-modal');
    const confirmPrintBtn = document.getElementById('confirm-print-btn');
    const cancelPrintBtn = document.getElementById('cancel-print-btn');
    const qrSizeSelect = document.getElementById('qr-size');
    const qrQuantityInput = document.getElementById('qr-quantity');
    
    let qrToPrintSrc = null;
    let qrToPrintName = null;

    function showQrPrintModal(qrImageSrc, itemName) {
        qrToPrintSrc = qrImageSrc;
        qrToPrintName = itemName;
        
        qrSizeSelect.value = 'M';
        qrQuantityInput.value = 1;

        qrPrintModal.classList.add('active');
    }

    function hideQrPrintModal() {
        qrPrintModal.classList.remove('active');
        qrToPrintSrc = null;
        qrToPrintName = null;
    }

    confirmPrintBtn.addEventListener('click', async () => {
        const size = qrSizeSelect.value;
        const quantity = parseInt(qrQuantityInput.value, 10) || 1;
        

        if(!qrToPrintName || !qrToPrintSrc) {
            console.error('Missing QR data');
            return;
        }
        showSuccessModal('PDF');
        confirmPrintBtn.textContent = 'Generating . . .' ; 
        confirmPrintBtn.disabled = true ; 
        try {
            const response = await fetch('/print_pdf',{
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body:JSON.stringify({
                    qr_image_src : qrToPrintSrc,
                    item_name : qrToPrintName,
                    quantity : quantity,
                    size : size
                })
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`)
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none' ;
            a.href = url ; 

            const disposition = response.headers.get('content-disposition');
            let filename = `${qrToPrintName.replace(/ /g,'_')}_${size}.pdf`
            a.download = filename ;
            document.body.appendChild(a);
            a.click();
            showSuccessModal();
            window.URL.revokeObjectURL(url);
            a.remove()
        } catch (error) {
            alert('Failed to print pdf file , please try again.');
        } finally {
            hideLoadingModal();
            if(localStorage.getItem('lang') == 'en'){
                confirmPrintBtn.textContent = 'Confirm';
            } else {
                confirmPrintBtn.textContent = 'ยืนยัน';
            }
            confirmPrintBtn.disabled = false ;
            hideQrPrintModal();
        };

    });

    document.getElementById('export-btn').addEventListener('click', async function(e) {
        e.preventDefault();

        showLoadingModal('Excel');
        
        const exportUrl = this.href; 

        try {
            const response = await fetch(exportUrl, {
                headers: { 'X-CSRFToken': CSRF_TOKEN },
                cache: 'no-store'
            });

            if (!response.ok) {
                throw new Error(`Server error (${response.status})`);
            }

            const blob = await response.blob();

            const disposition = response.headers.get('content-disposition');
            let filename = 'stock.xlsx'; 
            if (disposition && disposition.indexOf('attachment') !== -1) {
                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                const matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            
            document.body.appendChild(a);
            a.click(); 
            window.URL.revokeObjectURL(url);
            a.remove();

            hideLoadingModal();
            showSuccessModal('Excel'); 

        } catch (error) {
            console.error('Export failed:', error);
            hideLoadingModal();
            alert('Failed to export file. Please try again.');
        }
    });

    cancelPrintBtn.addEventListener('click', hideQrPrintModal);

    qrPrintModal.addEventListener('click', (event) => {
        if (event.target === qrPrintModal) {
            hideQrPrintModal();
        }
    });

    const successModal = document.getElementById('success-modal');
    const successContinueBtn = document.getElementById('success-continue-btn');
    const successMessageText = document.getElementById('success-message-text');

    function showSuccessModal(type = 'PDF') { 
        const lang = localStorage.getItem('lang') || 'th';
        let title, message, btnText;
        if (lang == 'th') {
            title = 'สำเร็จ!';
            btnText = 'ดำเนินการต่อ';
            if (type === 'Excel') {
                message = 'Excel ของคุณดาวน์โหลดเรียบร้อยแล้ว';
            } else { 
                message = 'PDF ของคุณดาวน์โหลดเรียบร้อยแล้ว';
            }
        } else {
            title = 'Success!';
            btnText = 'Continue';
            if (type === 'Excel') {
                message = 'Your Excel has been downloaded.';
            } else { 
                message = 'Your PDF has been downloaded.';
            }
        }
        document.getElementById('success-title-text').textContent = title;
        successMessageText.textContent = message;
        successContinueBtn.textContent = btnText;
        successModal.classList.add('active');
    }
    function hideSuccessModal() {
        successModal.classList.remove('active');
    }

    successContinueBtn.addEventListener('click', hideSuccessModal);
    successModal.addEventListener('click', (event) => {
        if (event.target === successModal) {
            hideSuccessModal();
        }
    });

    const loadingModal = document.getElementById('loading-modal');

    function showLoadingModal(type = 'PDF') { 
        const lang = localStorage.getItem('lang') || 'th';
        let title, message;

        if (lang == 'th') {
            title = 'กำลังสร้าง...';
            if (type === 'Excel') {
                message = 'ไฟล์ Excel ของคุณกำลังถูกจัดเตรียม';
            } else { 
                message = 'ไฟล์ PDF ของคุณกำลังถูกจัดเตรียม';
            }
        } else {
            title = 'Generating...';
            if (type === 'Excel') {
                message = 'Your Excel file is being prepared.';
            } else {
                message = 'Your PDF file is being prepared.';
            }
        }
        
        document.getElementById('loading-title-text').textContent = title;
        document.getElementById('loading-message-text').textContent = message;
        loadingModal.classList.add('active');
    }

    function hideLoadingModal() {
        loadingModal.classList.remove('active');
    }

    async function loadQrCode(itemID, summaryElement) {
        const detailsElement = summaryElement.parentElement;
        if (!detailsElement.open) {
            if (summaryElement.dataset.loaded === 'true') { return; }
            summaryElement.dataset.loaded = 'true';
            const placeholder = document.getElementById(`qr-placeholder-${itemID}`);
            placeholder.innerHTML = '<p>Loading QR Code...</p>';
            try {
                const response = await fetch(`/get_qr/${itemID}`);
                if (!response.ok) throw new Error('Failed to fetch QR code.');
                const data = await response.json();
                if (data.success) {
                    const qrImageSrc = `data:image/png;base64,${data.qr_code_base64}`;
                    placeholder.innerHTML = `
                        <div class="qr-container-description">
                            <h4>QR Code</h4>
                            <img src="${qrImageSrc}" alt="QR Code for ${data.item_name}">
                            <button type="button" onclick="showQrPrintModal('${qrImageSrc}', '${data.item_name}')">Print QR</button>
                        </div>
                    `;
                } else { throw new Error(data.error || 'Unknown error occurred.'); }
            } catch (error) {
                placeholder.innerHTML = `<p style="color: red;">${error.message}</p>`;
                delete summaryElement.dataset.loaded;
            }
        }
    }
    

    function renderItems(data) {
        $("#item-list").empty();
        if (!data.length) {
            if (localStorage.getItem('lang') == 'en') {
                itemShow = '<div class="text">No item to be shown yet.</div>'
            } else {
                itemShow = '<div class="text">ยังไม่มีรายการของให้แสดง ณ ขณะนี้</div>'
            }
            $("#item-list").append(itemShow)
        } else {
            data.forEach(it => {
                it.is_admin = {{ 1 if (current_user.is_admin or current_user.is_sadmin) else 0 }};
                $("#item-list").append(getDisplayHTML(it));
        })};
    }
    function gotoEdit(id){ window.location.href = `/edit?itemID=${id}`; }
    function withdraw(itemID) { window.location.href = `/withdraw?itemID=${itemID}`; }
    function filterCategory(cateName) {
        if (cateName === "all") { renderItems(items); } 
        else { renderItems(items.filter(it => it.category.cateName === cateName)); }
    }
    function searchCategory(query) {
        if (query === "") { renderItems(items); return; }
        const filteredData = items.filter(item =>
            item.itemName.toLowerCase().includes(query.toLowerCase()) || item.category.cateName.toLowerCase().includes(query.toLowerCase())
        );
        renderItems(filteredData);
    }
    document.querySelector('.search-bar input').addEventListener('input', (event) => searchCategory(event.target.value.trim()));

    function changeLanguage(lang) {
        if (!translations[lang]) lang = 'en'; // Fallback
        
        document.querySelector('#title').textContent = (translations[lang].title);
        document.querySelector('#search').placeholder = (translations[lang].search);

        document.querySelector('#confirm-delete-btn').textContent = (translations[lang].cnf);
        document.querySelector('#cancel-delete-btn').textContent = (translations[lang].cnc);

        document.querySelector('#qr-modal-title').textContent = (translations[lang].printOptions);
        document.querySelector('#qr-label-size').textContent = (translations[lang].size);
        document.querySelector('#qr-label-quantity').textContent = (translations[lang].quantity);
        document.querySelector('#confirm-print-btn').textContent = (translations[lang].cnf);
        document.querySelector('#cancel-print-btn').textContent = (translations[lang].cnc);

        const currentSearch = document.querySelector('.search-bar input').value.trim();
        if (currentSearch) {
            searchCategory(currentSearch);
        } else {
            renderItems(items); 
        }
    }
    
    window.onload = () => {
        changeLanguage(localStorage.getItem('lang') || 'th');
    };
</script>