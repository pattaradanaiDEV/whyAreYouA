<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pridi:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #000;
            --button-bg: #C85A1A;
            --button-text: #ffffff;
            --nav-bg: #555;
            --nav-icon-color: #e3e3e3;
        }
        .lightmode { --nav-bg: rgba(188, 188, 188, 0.5); --nav-icon-color: #000; }
        .darkmode { --nav-bg: #555; --nav-icon-color: #e3e3e3; }
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; background-color: var(--primary-bg); font-family: 'Inter', sans-serif;
        }
        #scanner-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #reader { width: 100%; height: 100%; border: none; }
        #reader video { width: 100%; height: 100%; object-fit: cover; }
        .ui-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            pointer-events: none;
        }
        .upload-button-container { width:100%; text-align:center; margin-bottom: 20px; }
        .upload-button {
            background-color: var(--button-bg); color: var(--button-text); border: none;
            border-radius: 25px; padding: 12px 24px; font-size: 1.1rem; font-family: 'Inter', sans-serif;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background-color 0.3s;
            pointer-events: all;
        }
        .upload-button:hover { background-color: #6d4424; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); display: none; justify-content: center;
            align-items: center; z-index: 1000; font-size: 1.2rem; color: #333;
        }
        .bottom-nav {
            position: relative; width: 100%; background-color: var(--nav-bg);
            display: flex; justify-content: space-between; padding: 10px 10px;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-sizing: border-box; pointer-events: all;
        }
        .nav-item {
            flex: 1; align-items: center; justify-content: center; display: flex;
            flex-direction: column; color: var(--nav-icon-color); font-size: 0.75rem;
            text-align: center; text-decoration: none;
        }
        .nav-item a { color: inherit; text-decoration: none; }
        .nav-item svg { height: 2.5rem; width: 2.5rem; fill: var(--nav-icon-color); }
        .nav-item span { font-size: 0.8rem; white-space: nowrap; }
    </style>
</head>
<body class="lightmode">
    <div id="scanner-wrapper"><div id="reader"></div></div>

    <div class="ui-overlay">
        <div class="upload-button-container">
             <input type="file" id="qr-input-file" accept="image/*" style="display: none;">
             <button class="upload-button" onclick="document.getElementById('qr-input-file').click();">Upload QR</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item">
                <a href="{{ url_for('category') }}">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M200-80q-33 0-56.5-23.5T120-160v-451q-18-11-29-28.5T80-680v-120q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v120q0 23-11 40.5T840-611v451q0 33-23.5 56.5T760-80H200Zm-40-600h640v-120H160v120Zm200 280h240v-80H360v80Z"/></svg>
                </a>
                <span>Stock</span>
            </div>
            <a href="{{ url_for('homepage') }}" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg>
                <span>Home</span>
            </a>
            <div class="nav-item">
                {% if current_user.IsM_admin %}
                    <a href="{{ url_for('adminlist') }}"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M720-400v-120H600v-80h120v-120h80v120h120v80H800v120h-80Zm-360-80q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Z"/></svg></a>
                    <span>Manage Admin</span>
                {% else %}
                    <a href="{{ url_for('adminlist')}}"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M720-400v-120H600v-80h120v-120h80v120h120v80H800v120h-80Zm-360-80q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Z"/></svg></a>
                    <span>Admin Contact</span>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="loading-overlay"><p>Processing QR Code...</p></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let darkmode = localStorage.getItem('darkmode');
            const body = document.body;
            if (darkmode === 'active') { body.classList.replace('lightmode', 'darkmode'); } 
            else { body.classList.replace('darkmode', 'lightmode'); }
        });

        const loadingOverlay = document.getElementById('loading-overlay');
        const fileInput = document.getElementById('qr-input-file');
        const html5Qrcode = new Html5Qrcode("reader");
        let isCameraScannerRunning = false;

        function showLoading() { loadingOverlay.style.display = 'flex'; }
        function hideLoading() { loadingOverlay.style.display = 'none'; }

        function handleDecodedText(decodedText) {
            showLoading();
            
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch("{{ url_for('handle_scan') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ scanned_url: decodedText }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok, status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    alert('Error: ' + (data.error || 'Unknown error from server'));
                    hideLoading();
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Failed to process QR code.');
                hideLoading();
            });
        }

        const onScanSuccess = (decodedText, decodedResult) => {
            if (isCameraScannerRunning) {
                html5Qrcode.stop().then(() => {
                    isCameraScannerRunning = false;
                    handleDecodedText(decodedText);
                }).catch(err => console.error("Failed to stop scanner", err));
            }
        };
        const onScanFailure = (error) => { /* do nothing */ };

        const qrboxFunction = (viewfinderWidth, viewfinderHeight) => {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            let qrboxSize = Math.floor(minEdge * 0.7);
            return { width: qrboxSize, height: qrboxSize };
        }

        function startCameraScanner() {
            html5Qrcode.start(
                { facingMode: "environment" }, { fps: 10, qrbox: qrboxFunction },
                onScanSuccess, onScanFailure
            ).then(() => { isCameraScannerRunning = true; })
            .catch(err => { console.error("Unable to start scanning.", err); });
        }

        fileInput.addEventListener('change', async e => {
            if (e.target.files.length === 0) return;
            if (isCameraScannerRunning) {
                try { await html5Qrcode.stop(); isCameraScannerRunning = false; } 
                catch(err) { console.warn("Camera could not be stopped gracefully.", err); }
            }
            showLoading();
            const imageFile = e.target.files[0];
            try {
                const decodedText = await html5Qrcode.scanFile(imageFile, false);
                handleDecodedText(decodedText);
            } catch (err) {
                hideLoading();
                alert(`Error scanning file. Please try again or use the camera.\n(${err})`);
                startCameraScanner();
            }
        });
        
        startCameraScanner();
    </script>
</body>
</html>