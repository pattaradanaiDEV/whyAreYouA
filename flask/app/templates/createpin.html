<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../static/css/createpin.css">
  <title>Create PIN</title>
</head>
<body>
  <div class="app-container">
      <img src="../static/ico/stock_logo.png" alt="stock-logo" class="logo" />
    
      <p class="app-title">CS' Stock Managing System</p>

      <p id="pin-title" class="pin-title">Create PIN:</p>
      <div class="pin-container">
          <form id="pin-form">
              <input type="password" class="pin" maxlength="1" required>
              <input type="password" class="pin" maxlength="1" required>
              <input type="password" class="pin" maxlength="1" required>
              <input type="password" class="pin" maxlength="1" required>
              <input type="password" class="pin" maxlength="1" required>
              <input type="password" class="pin" maxlength="1" required>
          </form>
      </div>
      <p id="error-message" style="color: red; display: none;">PINs do not match. Try again.</p>
  </div>

<script>
  const pins = document.querySelectorAll('.pin');
  const form = document.querySelector('#pin-form');
  const pinTitle = document.getElementById('pin-title');
  const errorMessage = document.getElementById('error-message');

  let firstPin = "";
  let step = 1; 

  pins.forEach((pin, index) => {
      pin.dataset.id = index;

      pin.addEventListener('keyup', (e) => {
          if (pin.value.length == 1) {
              if (index < pins.length - 1) {
                  pins[index + 1].focus();
              } else {
                  const enteredPin = Array.from(pins).map(p => p.value).join("");
                  
                  if (step === 1) {
                      firstPin = enteredPin;
                      step = 2;
                      pinTitle.textContent = "Confirm PIN:";
                      clearPins();
                      pins[0].focus();
                  } else {
                    if (enteredPin === firstPin) {
                        fetch("/save_pin", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ pin: enteredPin })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = "/home"; 
                            } else {
                                errorMessage.textContent = "Error: " + data.message;
                                errorMessage.style.display = "block";
                                step = 1;
                                pinTitle.textContent = "Create PIN:";
                                clearPins();
                                pins[0].focus();
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            errorMessage.textContent = "Server error, please try again.";
                            errorMessage.style.display = "block";
                        });
                      } else {
                          errorMessage.style.display = "block";
                          step = 1;
                          pinTitle.textContent = "Create PIN:";
                          clearPins();
                          pins[0].focus();
                      }
                  }
              }
          } else if (e.key === "Backspace" && index > 0) {
              pins[index - 1].focus();
          }
      });
  });

  function clearPins() {
      pins.forEach(p => p.value = "");
  }
</script>
</body>
</html>
