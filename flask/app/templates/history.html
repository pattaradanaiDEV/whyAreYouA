<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../static/css/history.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pridi:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=download" />
    <title>History Page</title>
</head>
<body class=""> 
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const mode = localStorage.getItem('darkmode');
          if (mode === 'dark') {
            document.body.classList.add('darkmode');
            document.body.classList.remove('lightmode');
          } else {
            document.body.classList.add('lightmode');
            document.body.classList.remove('darkmode');
          }
        });
    </script>
    <script>
        const CSRF_TOKEN = "{{ csrf_token() }}";
    </script>
    <div class="top-bar">
        <a href="{{ url_for('homepage') }}">
            <span class="material-icons">arrow_back_ios</span>
        </a>
        <div class="center">
            <span id="title">History</span>
        </div>
        <a href="{{ url_for('export') }}" id="export-btn">
            <span class="material-symbols-outlined">download</span>
        </a>
    </div>
    
    {% if history %}
        {% for set in history %}
            {% if not (current_user.is_admin or current_user.is_sadmin) %}
                {% if current_user.UserID == set.UserID %}
                    <div class="card" data-id="{{ set.itemID }}">
                        <div class="item">
                            <div class="item-text">
                                <span class="withdrawer">Withdrawer</span><span>{{ set.user.Fname }} {{ set.user.Lname }}</span>
                            </div>
                            <div class="item-text">
                                <span class="itemName">Item name</span><span>{{ set.items.itemName }}</span>
                            </div>
                            <div class="item-text">
                                <span class="itemAmount">Item amount</span><span>{{ set.Quantity }}</span>
                            </div>
                            <div class="item-text">
                                <span class="category">Category</span><span>{{ set.items.category.cateName }}</span>
                            </div>
                            <div class="item-text">
                                <span class="time">Withdraw time</span>
                                <span class="time-value" data-utc-time="{{ (set.DateTime | string)[0:19] }}"></span>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% else %}
            <div class="card" data-id="{{ set.itemID }}">
                <div class="item">
                    <div class="item-text">
                        <span class="withdrawer">Withdrawer</span><span>{{ set.user.Fname }} {{ set.user.Lname }}</span>
                    </div>
                    <div class="item-text">
                        <span class="itemName">Item name</span><span>{{ set.items.itemName }}</span>
                    </div>
                    <div class="item-text">
                        <span class="itemAmount">Item amount</span><span>{{ set.Quantity }}</span>
                    </div>
                    <div class="item-text">
                        <span class="category">Category</span><span>{{ set.items.category.cateName }}</span>
                    </div>
                    <div class="item-text">
                        <span class="time">Withdraw time</span>
                        <span class="time-value" data-utc-time="{{ (set.DateTime | string)[0:19] }}"></span>
                    </div>
                </div>
            </div>
            {% endif %}
        
        {% endfor %}
    {% else %}
        <p class="item-text" id="noData">No data yet</p>
    {% endif %}
    <div class="modal-overlay" id="success-modal">
        <div class="modal-content success-modal-content">
            <div class="success-icon">
                <span class="material-icons">check</span>
            </div>
            <h3 class="success-title" id="success-title-text">Success!</h3>
            <p class="modal-message" id="success-message-text">Your Excel has been downloaded.</p>
            <div class="modal-actions">
                <button class="modal-btn success" id="success-continue-btn">Continue</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="loading-modal">
        <div class="modal-content success-modal-content">
            <div class="spinner"></div>
            
            <h3 class="success-title" id="loading-title-text">Generating...</h3>
            <p class="modal-message" id="loading-message-text">Your Excel file is being prepared.</p>
        </div>
    </div>
</body>
</html>
<script>
    
    const translations = {
        en: {
            title: "History",
            withdrawer: "Withdrawer",
            itemName: "Item name",
            itemAmount: "Item amount",
            category: 'Category',
            time: 'Withdraw time'
        },
        th: {
            title: "ประวัติ",
            withdrawer: "ผู้เบิก",
            itemName: "ชื่อของ",
            itemAmount: "จำนวนของ",
            category: 'ประเภท',
            time: 'เวลาที่เบิก'
        }
    };

    function changeLanguage(lang) {
        document.querySelector('#title').textContent = (translations[lang].title);
        document.querySelectorAll('.withdrawer').forEach(e => {
            e.textContent = (translations[lang].withdrawer);
        });
        document.querySelectorAll('.itemName').forEach(e => {
            e.textContent = (translations[lang].itemName);
        });
        document.querySelectorAll('.itemAmount').forEach(e => {
            e.textContent = (translations[lang].itemAmount);
        });
        document.querySelectorAll('.category').forEach(e => {
            e.textContent = (translations[lang].category);
        });
        document.querySelectorAll('.time').forEach(e => {
            e.textContent = (translations[lang].time);
        });
    }
    const successModal = document.getElementById('success-modal');
    const successContinueBtn = document.getElementById('success-continue-btn');
    const successMessageText = document.getElementById('success-message-text');

    function showSuccessModal(message) {
        if (localStorage.getItem('lang') == 'th') {
            document.getElementById('success-title-text').textContent = 'สำเร็จ!';
            successMessageText.textContent = message || 'Excel ของคุณดาวน์โหลดเรียบร้อยแล้ว';
            successContinueBtn.textContent = 'ดำเนินการต่อ';
        } else {
            document.getElementById('success-title-text').textContent = 'Success!';
            successMessageText.textContent = message || 'Your Excel has been downloaded.';
            successContinueBtn.textContent = 'Continue';
        }
        successModal.classList.add('active');
    }

    function hideSuccessModal() {
        successModal.classList.remove('active');
    }

    successContinueBtn.addEventListener('click', hideSuccessModal);
    successModal.addEventListener('click', (event) => {
        if (event.target === successModal) {
            hideSuccessModal();
        }
    });
    
    const loadingModal = document.getElementById('loading-modal');

    function showLoadingModal() {
        if (localStorage.getItem('lang') == 'th') {
            document.getElementById('loading-title-text').textContent = 'กำลังสร้าง...';
            document.getElementById('loading-message-text').textContent = 'ไฟล์ Excel ของคุณกำลังถูกจัดเตรียม';
        } else {
            document.getElementById('loading-title-text').textContent = 'Generating...';
            document.getElementById('loading-message-text').textContent = 'Your Excel file is being prepared.';
        }
        loadingModal.classList.add('active');
    }

    function hideLoadingModal() {
        loadingModal.classList.remove('active');
    }

    document.getElementById('export-btn').addEventListener('click', async function(e) {
        e.preventDefault();

        showLoadingModal();
        
        const exportUrl = this.href; 

        try {
            const response = await fetch(exportUrl, {
                headers: { 'X-CSRFToken': CSRF_TOKEN },
                cache: 'no-store'
            });

            if (!response.ok) {
                throw new Error(`Server error (${response.status})`);
            }

            const blob = await response.blob();

            const disposition = response.headers.get('content-disposition');
            let filename = 'history.xlsx'; 
            if (disposition && disposition.indexOf('attachment') !== -1) {
                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                const matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            
            document.body.appendChild(a);
            a.click(); 
            window.URL.revokeObjectURL(url);
            a.remove();

            hideLoadingModal();
            showSuccessModal(); 

        } catch (error) {
            console.error('Export failed:', error);
            hideLoadingModal();
            alert('Failed to export file. Please try again.');
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.time-value').forEach(span => {
            const utcTimeString = span.dataset.utcTime; 
            if (utcTimeString) {
                
                const isoUtcString = utcTimeString.replace(' ', 'T') + 'Z';
                const date = new Date(isoUtcString);
  
                const bkkTime = date.toLocaleString('en-CA', {
                    timeZone: 'Asia/Bangkok',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false 
                });
                
            
                span.textContent = bkkTime.replace(',', '');
            }
        });
        
        changeLanguage(localStorage.getItem('lang'));
    });
</script>

